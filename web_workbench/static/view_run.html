<META HTTP-EQUIV="CACHE-CONTROL" CONTENT="NO-CACHE">
<html>
<!--
Copyright (c) 2011-2013 F-Secure
See LICENSE for details
-->
<head>
<title>Realms of test logs</title>
<script src='utils.js'></script>
<script src='run_log.js'></script>
<body>
<div id='actions' style="border: 1px solid;">
<span id='vnc link'><text>Vnc</text></span>&nbsp;<span id='rdc link'><text>Rdc</text></span>&nbsp;<span id='my vnc'><a href='vnc://192.168.56.101:5900'>MyVnc</a></span><br>
<input type=button id='deallocate' value='Deallocate VM' disabled onclick='deallocate_remote_machine();'><br>
</div>
Run Log:
<pre id='content'>
</pre>
<img id='error screenshot' src=''>
</body>
<script>

function openvnc(ip, port) {
    window.open('http://www.gtn/ta-utils/kvm/vnc.html?host=' + ip + '&port=' + port, '_blank');
    window.focus();
}

function is_remote_machine_available() {
    var is_alive = log.is_remote_machine_alive();
    if (is_alive == false)
        return false;
    
    var machine_id = log.get_remote_machine_id();
    var vnc = log.get_vnc();
    if (machine_id != null && vnc != null) {
        var xmlhttp = new XMLHttpRequest();
        xmlhttp.onreadystatechange=function() {
            if (xmlhttp.readyState==4 && xmlhttp.status==200) {
                response = eval("("+xmlhttp.responseText+")")
                if (response.result == true) {
                    if (response.status == 'allocated') {
                        log.set_remote_machine_alive(true);
                    } else {
                        log.set_remote_machine_alive(false);
                    }
                }
                update_action_bar();
            }
        }
        xmlhttp.open("GET","http://" + vnc.ip + "/status?image_id=" + machine_id, true);
        xmlhttp.send();
    }
    return log.is_remote_machine_alive();
}

function deallocate_remote_machine() {
    var machine_id = log.get_remote_machine_id();
    var vnc = log.get_vnc();
    if (machine_id != null && vnc != null) {
        log.set_remote_machine_alive(false);
        update_action_bar();
        var xmlhttp = new XMLHttpRequest();
        xmlhttp.open("POST","http://" + vnc.ip + "/deallocate?image_id=" + machine_id, true);
        var obj = {image_id: machine_id};
        xmlhttp.send(JSON.stringify(obj));
    }
}

function set_rdc_as_text() {
    var current_element = document.getElementById('rdc link');
    if (current_element.firstChild) {
        current_element.removeChild(current_element.firstChild);
    }
    var text_node = document.createTextNode("Rdc");
    current_element.appendChild(text_node);
}

function set_rdc_as_link() {
    var current_element = document.getElementById('rdc link');
    while (current_element.firstChild) {
        current_element.removeChild(current_element.firstChild);
    }
    var link_node = document.createElement("a");
    link_node.appendChild(document.createTextNode("rdc"));
    var ip = log.get_ip();
    if (ip != null) {
        link_node.href = 'rdp://' + ip;
    }
    current_element.appendChild(link_node);
}

function set_vnc_as_text() {
    var current_element = document.getElementById('vnc link');
    if (current_element.firstChild) {
        current_element.removeChild(current_element.firstChild);
    }
    var text_node = document.createTextNode("Vnc");
    current_element.appendChild(text_node);
}

function set_vnc_as_link() {
    var current_element = document.getElementById('vnc link');
    while (current_element.firstChild) {
        current_element.removeChild(current_element.firstChild);
    }
    var link_node = document.createElement("a");
    link_node.appendChild(document.createTextNode("Vnc"));
    var vnc = log.get_vnc();
    if (vnc != null) {
        link_node.href = 'javascript:openvnc("' + vnc.ip + '",' + vnc.port + ');';
    }
    current_element.appendChild(link_node);
}


function update_action_bar() {
    if (log.is_remote_machine_alive()) {
        set_vnc_as_link();
        if (log.finished()) {
            set_rdc_as_link();
            document.getElementById('deallocate').disabled = false;
        } else {
            document.getElementById('deallocate').disabled = true;
        }
    } else {
        set_vnc_as_text();
        set_rdc_as_text();
        document.getElementById('deallocate').disabled = true;
    }
}

function draw_action_bar() {
    is_remote_machine_available();
}

//view_run(QueryString.id);
log = new RunLog(QueryString.id);

function log_reloaded() {
    draw_action_bar();
    content = document.getElementById('content');
    while (content.childNodes.length > 0)
            content.removeChild(content.firstChild);

    var text = document.createTextNode(log.get_text());
    content.appendChild(text);
    var machine_id = log.get_remote_machine_id();
    //if machine id is still running, enable vnc, rdc and deallocation links
    
    if (log.finished() == false) {
        setTimeout(request_reload_log, 1000);
    }
}
function request_reload_log() {
    log.reload(log_reloaded);
}
request_reload_log();
document.getElementById('error screenshot').src = '/murphy/get_run_screenshot?id=' + QueryString.id
</script>
</html>